<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>K线图调试页面</title>
    <style>
        body { background: #0a0e1a; color: #fff; font-family: monospace; padding: 20px; }
        .test { margin: 20px 0; padding: 10px; border: 1px solid #333; }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        #chart { width: 600px; height: 300px; margin: 20px 0; border: 1px solid #666; }
    </style>
</head>
<body>
    <h1>K线图诊断测试</h1>
    
    <div class="test">
        <h3>1. Lightweight Charts 库加载状态</h3>
        <div id="lib-check">检查中...</div>
    </div>
    
    <div class="test">
        <h3>2. API 连接测试</h3>
        <div id="api-check">检查中...</div>
    </div>
    
    <div class="test">
        <h3>3. K线图渲染测试</h3>
        <div id="chart"></div>
        <div id="chart-status">准备渲染...</div>
    </div>

    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        // 测试1：检查库是否加载
        setTimeout(() => {
            const libCheck = document.getElementById('lib-check');
            if (typeof LightweightCharts !== 'undefined') {
                libCheck.innerHTML = '<span class="success">✅ LightweightCharts 已成功加载</span>';
                libCheck.innerHTML += '<br>版本：' + (LightweightCharts.version || '未知');
            } else {
                libCheck.innerHTML = '<span class="error">❌ LightweightCharts 未加载</span>';
            }
        }, 500);

        // 测试2：API连接
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? ''
            : 'https://api.aizidonghua.top';
        
        setTimeout(async () => {
            const apiCheck = document.getElementById('api-check');
            try {
                const response = await fetch(`${API_BASE}/api/kline?symbol=BTC&interval=5m`, { credentials: 'include' });
                const data = await response.json();
                
                if (data.candles && data.candles.length > 0) {
                    apiCheck.innerHTML = `<span class="success">✅ API 连接成功</span><br>`;
                    apiCheck.innerHTML += `Symbol: ${data.symbol}<br>`;
                    apiCheck.innerHTML += `Interval: ${data.interval}<br>`;
                    apiCheck.innerHTML += `Candles: ${data.candles.length} 根<br>`;
                    apiCheck.innerHTML += `Indicators: ${data.indicators ? 'EMA20/50, RSI7/14' : '无'}`;
                } else {
                    apiCheck.innerHTML = '<span class="error">❌ API 返回数据为空</span>';
                }
            } catch (error) {
                apiCheck.innerHTML = `<span class="error">❌ API 连接失败: ${error.message}</span>`;
            }
        }, 1000);

        // 测试3：渲染K线图
        setTimeout(async () => {
            const container = document.getElementById('chart');
            const statusDiv = document.getElementById('chart-status');
            
            if (typeof LightweightCharts === 'undefined') {
                statusDiv.innerHTML = '<span class="error">❌ 无法渲染：库未加载</span>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/kline?symbol=BTC&interval=5m`, { credentials: 'include' });
                const data = await response.json();

                if (!data.candles || data.candles.length === 0) {
                    statusDiv.innerHTML = '<span class="error">❌ 无法渲染：无数据</span>';
                    return;
                }

                const chart = LightweightCharts.createChart(container, {
                    width: 600,
                    height: 300,
                    layout: {
                        background: { color: '#0a0e1a' },
                        textColor: '#9ca3af',
                    },
                    grid: {
                        vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
                        horzLines: { color: 'rgba(255, 255, 255, 0.05)' },
                    },
                });

                const candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#ef4444',
                    downColor: '#22c55e',
                    borderDownColor: '#22c55e',
                    borderUpColor: '#ef4444',
                    wickDownColor: '#22c55e',
                    wickUpColor: '#ef4444',
                });

                const candleData = data.candles.map(c => ({
                    time: Math.floor(c.timestamp / 1000),
                    open: c.open,
                    high: c.high,
                    low: c.low,
                    close: c.close,
                }));

                candlestickSeries.setData(candleData);
                chart.timeScale().fitContent();

                statusDiv.innerHTML = '<span class="success">✅ K线图渲染成功！</span>';
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">❌ 渲染失败: ${error.message}</span>`;
                console.error('渲染错误:', error);
            }
        }, 1500);
    </script>
</body>
</html>
